---
import MainLayout from '@/layouts/MainLayout.astro';
import { filmService } from '@/lib/api/services/filmService';
import { MovieGrid } from '@/components/movie/MovieGrid';
import { Pagination } from '@/components/ui/Pagination';
import { FilterBar } from '@/components/ui/FilterBar';
import type { Film } from '@/types/film';

const url = new URL(Astro.request.url);
const query = url.searchParams.get('q') || '';
const category = url.searchParams.get('category');
const country = url.searchParams.get('country');
const year = url.searchParams.get('year');
const type = url.searchParams.get('type');
const sort = url.searchParams.get('sort');

const lastId = url.searchParams.get('lastId');
const lastView = url.searchParams.get('lastView');
const lastCreatedAt = url.searchParams.get('lastCreatedAt');
const firstId = url.searchParams.get('firstId');
const firstView = url.searchParams.get('firstView');
const firstCreatedAt = url.searchParams.get('firstCreatedAt');

let films: Film[] = [];
let nextCursor = null;
let error = null;

// Hardcoded data for filters
const categories = [
  { value: 'hanh-dong', label: 'Hành Động' },
  { value: 'tinh-cam', label: 'Tình Cảm' },
  { value: 'hai-huoc', label: 'Hài Hước' },
  { value: 'co-trang', label: 'Cổ Trang' },
  { value: 'tam-ly', label: 'Tâm Lý' },
  { value: 'hinh-su', label: 'Hình Sự' },
  { value: 'chien-tranh', label: 'Chiến Tranh' },
  { value: 'the-thao', label: 'Thể Thao' },
  { value: 'vo-thuat', label: 'Võ Thuật' },
  { value: 'vien-tuong', label: 'Viễn Tưởng' },
  { value: 'phieu-luu', label: 'Phiêu Lưu' },
  { value: 'khoa-hoc', label: 'Khoa Học' },
  { value: 'kinh-di', label: 'Kinh Dị' },
  { value: 'am-nhac', label: 'Âm Nhạc' },
  { value: 'than-thoai', label: 'Thần Thoại' },
  { value: 'tai-lieu', label: 'Tài Liệu' },
  { value: 'gia-dinh', label: 'Gia Đình' },
  { value: 'chinh-kich', label: 'Chính Kịch' },
  { value: 'bi-an', label: 'Bí Ẩn' },
  { value: 'hoc-duong', label: 'Học Đường' },
];

const countries = [
  { value: 'trung-quoc', label: 'Trung Quốc' },
  { value: 'han-quoc', label: 'Hàn Quốc' },
  { value: 'nhat-ban', label: 'Nhật Bản' },
  { value: 'au-my', label: 'Âu Mỹ' },
  { value: 'thai-lan', label: 'Thái Lan' },
  { value: 'hong-kong', label: 'Hồng Kông' },
  { value: 'dai-loan', label: 'Đài Loan' },
  { value: 'viet-nam', label: 'Việt Nam' },
  { value: 'an-do', label: 'Ấn Độ' },
  { value: 'phap', label: 'Pháp' },
  { value: 'anh', label: 'Anh' },
  { value: 'canada', label: 'Canada' },
  { value: 'duc', label: 'Đức' },
  { value: 'tay-ban-nha', label: 'Tây Ban Nha' },
];

const hasFilters = query || category || country || year || type || sort;

if (hasFilters) {
  try {
    const filter = {
      keyword: query,
      limit: 24,
      ...(category && { categories: [category] }),
      ...(country && { countries: [country] }),
      ...(type && { types: [type] as any }),
      ...(year && { year: Number(year) }),
      ...(sort && { sort }),
      ...(lastId && {
        lastCursor: { id: lastId, view: Number(lastView), createdAt: lastCreatedAt || '' },
      }),
      ...(firstId && {
        firstCursor: { id: firstId, view: Number(firstView), createdAt: firstCreatedAt || '' },
      }),
    };

    console.log('Calling filmService in tim-kiem.astro');

    // Use getHotFilms as fallback if only category is present (for testing/stability)
    // You can revert this to filterFilms later if confirmed working
    if (category && !query && !country && !year && !type && !sort) {
      console.log('Using getHotFilms fallback for category:', category);
      // Note: getHotFilms returns { data: Film[] }
      const hotData = await filmService.getHotFilms();
      films = hotData.data || [];
    } else {
      const data = await filmService.filterFilms(filter);
      films = data.data || [];
      nextCursor = data.nextCursor;
    }
  } catch (e) {
    error = e;
    console.log('Error searching films:', e instanceof Error ? e.message : String(e));
  }
}

const getNextLink = () => {
  if (!nextCursor) return undefined;
  const params = new URLSearchParams();
  if (query) params.set('q', query);
  if (category) params.set('category', category);
  if (country) params.set('country', country);
  if (year) params.set('year', year);
  if (type) params.set('type', type);
  if (sort) params.set('sort', sort);

  params.set('lastId', nextCursor.id);
  params.set('lastView', nextCursor.view.toString());
  params.set('lastCreatedAt', nextCursor.createdAt);
  return `?${params.toString()}`;
};

const getPrevLink = () => {
  if (lastId || firstId) {
    const params = new URLSearchParams();
    if (query) params.set('q', query);
    if (category) params.set('category', category);
    if (country) params.set('country', country);
    if (year) params.set('year', year);
    if (type) params.set('type', type);
    if (sort) params.set('sort', sort);
    return `/tim-kiem?${params.toString()}`;
  }
  return undefined;
};
---

<MainLayout title={query ? `Tìm kiếm: ${query} - CineVerse` : 'Tìm Kiếm & Lọc Phim - CineVerse'}>
  <div class="container-custom py-8 md:py-12">
    <div class="mb-8 space-y-6">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-neutral-500" fill="none"
        stroke="currentColor" viewBox="0 0 24 24" >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </div>
    </div>
    {/* Preserve other filters when searching */}
    {category && <input type="hidden" name="category" value={category} />}
    {country && <input type="hidden" name="country" value={country} />}
    {year && <input type="hidden" name="year" value={year} />}
    {type && <input type="hidden" name="type" value={type} />}
    {sort && <input type="hidden" name="sort" value={sort} />}
  </div>
</MainLayout>

<!-- Advanced Filters -->
<FilterBar
  categories={categories}
  countries={countries}
  currentFilters={{ category, country, year, type, sort }}
  client:load
/>

{
  hasFilters && !error && (
    <div class="mb-6">
      <p class="text-text-secondary">
        {films.length > 0
          ? `Tìm thấy ${films.length} kết quả phù hợp`
          : 'Không tìm thấy kết quả phù hợp'}
      </p>
    </div>
  )
}

{
  error ? (
    <div class="text-center py-12">
      <p class="text-text-muted">Không thể tải dữ liệu. Vui lòng thử lại sau. {error.message}</p>
    </div>
  ) : hasFilters ? (
    films.length > 0 ? (
      <>
        <MovieGrid movies={films} client:only="react" />
        <Pagination
          hasPrevPage={!!(lastId || firstId)}
          hasNextPage={!!nextCursor}
          prevLink={getPrevLink()}
          nextLink={getNextLink()}
          className="mt-16"
        />
      </>
    ) : (
      <div class="text-center py-20 bg-neutral-900/50 rounded-2xl border border-white/5">
        <svg
          class="mx-auto h-16 w-16 text-neutral-700 mb-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"
          />
        </svg>
        <h3 class="text-xl font-semibold mb-2 text-white">Không tìm thấy phim</h3>
        <p class="text-text-muted max-w-md mx-auto">
          Thử điều chỉnh bộ lọc hoặc từ khóa tìm kiếm của bạn để có nhiều kết quả hơn.
        </p>
        <button
          onclick="window.location.href='/tim-kiem'"
          class="mt-6 px-6 py-2 bg-neutral-800 hover:bg-neutral-700 rounded-full text-sm font-medium transition-colors"
        >
          Xóa tất cả bộ lọc
        </button>
      </div>
    )
  ) : (
    <div class="text-center py-32">
      <div class="w-20 h-20 bg-neutral-900 rounded-full flex items-center justify-center mx-auto mb-6">
        <svg
          class="w-10 h-10 text-neutral-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
      </div>
      <h2 class="text-2xl font-bold mb-3 text-white">Khám phá kho phim khổng lồ</h2>
      <p class="text-text-muted max-w-lg mx-auto">
        Sử dụng bộ lọc bên trên hoặc nhập từ khóa để tìm kiếm bộ phim yêu thích của bạn trong hàng
        ngàn tựa phim hấp dẫn.
      </p>
    </div>
  )
}
